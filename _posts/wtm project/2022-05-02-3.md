---
title:  "wtm 프로젝트 kakao api"
excerpt: "프로젝트"

toc: true
toc_sticky: true
toc_label: "TOC"

categories:
  - project
last_modified_at: 2022-05-16T12:00:00-50:00
---

스크래핑에 이어서 다음 목표는 **카카오톡 API를 사용하여 정해진 시간에 스크리핑 내용을 전송하는 프로그램 구현** 이다.

## 카카오톡 api관련 실습
구현에 초점을 맞추기전에 어떻게 사용하는지에 대해서 알아보고자 했다.  
카카오 API 사용에 대해서 다음에 블로그를 참고하였다.  

[GGRS: Geoscience, GIS, & Remote Sensing - 카카오 API를 이용하여 나에게 메시지 보내기](https://blog.daum.net/geoscience/1624).  
[GGRS: Geoscience, GIS, & Remote Sensing - 카카오톡 메시지 API를 이용하여 친구에게 메시지 보내기](https://blog.daum.net/geoscience/1636).

위의 실습과 kakao developers의 공식문서를 참고하여 구현하고자할때 다음과 같이 구분할 수 있지 않을까 생각하였다.  
1. 서비스 이용을 위한 로그인 과정
2. API를 이용한 메시지 전송 과정

특히 메시지 전송 구현에 관하여 카카오링크 API, 카카오톡메시지 API 두가지 방법이 존재하는데 차이점으로 카카오톡메시지 API에만 REST API를 지원한다. 기존에 파이썬을 이용하여 스크래핑하였기 때문에 스크래핑한 결과를 파이썬의 자료형으로 바로 사용하기 용이하므로 REST API를 지원하는 카카오톡메시지 API를 이용하여 구현하고자 하였다.  

## 로그인 구현
다음은 REST API의 로그인이 작동하는 시퀸스 다이어그램이다.  
![로그인 시퀸스 다이어그램](https://developers.kakao.com/docs/latest/ko/assets/style/images/kakaologin/kakaologin_sequence.png){: width="70%" height="70%"}

### step1 인가코드 받기
시퀸스 다이어그램 step1를 살펴보면 인가코드를 받는 과정이 존재한다. 이때 get방식으로 인가코드를 받게되며 서비스 서버를 이용하여 인가코드를 받게되는데
구현간 코드값을 직접 받아올 수 있는 웹서버를 구동하기에는 현재 상황상 어려울 뿐만아니라 로그인 구현만을 위해 웹서버를 구동하기에는 너무 큰 기회비용이 든다고 생각하였다.

따라서 실습 블로그에 나와있던 방식으로 URl에 나와있는(get방식)의 인가코드를 직접 가져와서 토큰을 가져오기 위해 활용하였다.  

### step2 토큰 받기
토큰을 받는 과정은 두개의 코드로 구분하여 구현하였다.  

1. step1의 인가코드를 이용하여 refresh토큰을 발급받는 get_refresh_token.py를 구현하였고
2. 필요시마다 생명주기가 짧은 access토큰을 발급받기 위해 get_access_token.py를 구현하였다.

get_refresh_token.py은 인가코드를 이용하여 refresh토큰을 post형식으로 받는 간단한 코드이다.

get_access_token.py에 refresh토큰 정보를 저장하여 access토큰이 필요할때 해당 코드만 실행시키면 access토큰을 발급 받을 수 있도록 구현하였으며 코드실행의 결과물인 access토큰을 json파일로 저장함으로써 모듈화 하였다.

step2 토큰 받기를 구현하며 첫번째로 Json이 무엇인지 또 어떻게 사용하는지에 대해 어려웠던거같다.  
Json란 무엇인가 정도만 알고있어서 좀 더 Json에 알아가고 어떻게 사용하는지를 배우는 과정에서 많은 시간을 사용했다.  

또한 Json 토큰을 코드랑 같은 폴더에 저장하였는데 Json을 어떻게 저장해야하는지에 고민을 해보았다.  
관련하여 여러 방법을 찾아보고 의문점을 많이가지고 여러 자료를 찾아보았지만 해결점을 찾을 수 없었다. 
지금도 이러한 방식으로 Json을 저장하였을때의 보안상 문제점이 무엇인지 의문이다.
여러 생각을 해보았는데 DB가 크게 필요없어 DB를 사용하지 않지만 대부분의 서비스는 DB를 사용하며 DB를 사용할 경우 DB에 토큰정보를 그대로 넣으면 되기 때문에 관련하여 정보가 없는 것 같다는 생각이 들었다.  

현재 유저가 한명이기 때문에 Json파일도 하나일 뿐만아니라 카카오톡 권한조치로 인하여 보안상문제가 크게 발생하지 않겠다라는 생각이 들어 그대로 구현하였다.  

추가적으로 토큰에 대해 알아가는 과정에서 많은 시간을 사용하였다. 저번에 DB관련 프로젝트를 하며 로그인을 구현한적이 있었는데 그때는 세션을 통하여 구현하였기 때문에 토큰에 대해 생소한 상태였다. 토큰을 사용하면서 access토큰말고도 refresh토큰도 사용하는지에 대한 궁금증이 있었는데 

아래의 글을 통하여 대략적으로 보안상의 취약점을 제거하기 위해 즉  

[Tecoble - refresh token 도입기](https://tecoble.techcourse.co.kr/post/2021-10-20-refresh-token/).  
> access token + refresh token의 조합을 구성하면 access token의 경제적인 장점과 refresh token의 보안적인 장점을 둘 다 챙길 수 있다.

을 달성하기 위해 쓰인 다는 것을 알게 되었다. 현재 구현시 아침,점심,저녁때에만 토큰이 필요하므로 위의 장점에 대해 더욱 효과적이라고 생각이 들었으며 "refresh token을 이용하여 메시지를 보낼 때 access token을 받는다"라는 대략적인 구조도 생각하게 되었다.  

## 메시지 전송

![카카오톡 메시지 시퀸스 다이어그램](https://developers.kakao.com/docs/latest/ko/assets/style/images/message/message_talk.png){: width="80%" height="80%"}

메시지 전송에 관한 kakao developers에서 제공하는 시퀸스 다이어그램이다. 위의 과정을 두개로 나누어 구현하고자 했다.   

1. 카카오톡 친구 데이터 가져오기
2. 카카오톡 메시지 보내기(메시지 API호출)

### step1 카카오톡 친구 데이터 가져오기

친구 가져오기는 get_friends_list.py 코드로 구현하였고 간단히 토큰을 이용하여 카카오서버에 친구목록을 요청하는 방식이다. 기능을 함수화하여 다음단계인 메시지 보내기 단계에서 사용할 수 있도록하였다.   
앞서 실습 및 JWT에 대해 알아보았기 때문에 쉽게 구현할 수 있었다.  

### step2 카카오톡 메시지 보내기(메시지 API호출)

메시지 보내기는 send_menu.py 코드로 구현하였고 위와같이 간단하게 JWT를 가져오고 위의 친구 가져오는 함수로 친구목록을 가져온 후 친구목록과 메시지를 Json형식으로 만든다음 카카오톡 메시지 API로 요청하는 형태로 구현하였다.  

쉽게 구현 할 수 있다고 생각하였는데 Json 형식에 맞추다보니 생각보다 시간도 많이 걸리고 어려움이 많았던거 같다.  
특히 파이썬 자료형을 Json형태로 변경하는 것에 오랜시간이 걸렸는데 알면서 해결한 느낌이 아니라 어찌 이것저것해보다 보니 성공한 느낌이다.  
익숙치 않다보니 시간이 많이 걸리는 것은 당연한것이 맞다고 생각하면서도 막상 결과물을 보다보니 그렇게 오래걸릴일도 아니였던거 같다는 생각이 들었다.  
다른곳에서 Json을 사용하게되면 더욱 빠르게, 효율적으로 사용하기 위해 다시 추가적인 공부가 필요하겠다라는 생각이 들었다.  

## 이후
위의 과정을 통하여 어느정도 카카오톡 메시지를 보낼 수 있는 여건을 마련해 놓았다. 생각해보면 보내는 여건만이 아니라 원하는 기능을 구현하기 위해 더 조금더 생각하면서 구현하였기 때문에 보다 많은 발전이 있었다고 생각된다.  

앞으로 구현한 두개의 기능 웹스크래핑과 메시지 전송을 결합하면 마무리 될 것으로 보인다.  

특이 이번 과정이 새로운 기술들이 많았기 때문에 얻은 것도 많다고 생각하며 추가적으로 아는것이 많으면 시야가 다르다 라는 말에 대해 직접 격어본 경험인거같다.  
어디서 한번 듣거나 조금이라도 써본 기술들이 구현간에 시작점을 찾는데 큰 도움이 된 것같고 또 처음 시도하는 것에 대해서는 어떻게 시작할지 오랜시간을 소모하였다.  
이번에 배운것들이 아쉬운 부분들도 있겠지만 다른 것들을 시도할때 추가적인 도움이 되지않을까 싶다.  

